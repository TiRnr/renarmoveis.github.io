<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Identifica√ß√£o de Usu√°rio</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 900px;
            width: 100%;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4a6ee0 0%, #8a2be2 100%);
            color: white;
            padding: 40px;
            text-align: center;
            position: relative;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }
        
        .user-avatar {
            width: 100px;
            height: 100px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            margin: 0 auto 20px;
            border: 4px solid white;
        }
        
        .content {
            padding: 40px;
        }
        
        .identification-area {
            background: #f8f9ff;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            border: 2px dashed #4a6ee0;
        }
        
        .user-name-display {
            font-size: 2.2rem;
            color: #2c5282;
            text-align: center;
            margin: 20px 0;
            min-height: 60px;
        }
        
        .detected-name {
            background: linear-gradient(135deg, #4a6ee0, #8a2be2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: bold;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        
        .info-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            border-left: 4px solid #4a6ee0;
        }
        
        .info-card h3 {
            color: #4a6ee0;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .info-item {
            margin: 8px 0;
        }
        
        .label {
            font-weight: bold;
            color: #555;
            display: block;
            font-size: 0.9rem;
        }
        
        .value {
            color: #2c5282;
            word-break: break-all;
        }
        
        .progress-container {
            background: #f0f2ff;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .progress-bar {
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4a6ee0, #8a2be2);
            width: 0%;
            transition: width 1s ease;
        }
        
        .technique-list {
            list-style: none;
            margin-top: 15px;
        }
        
        .technique-item {
            padding: 8px;
            margin: 5px 0;
            background: #f8f9ff;
            border-radius: 5px;
            border-left: 3px solid #4a6ee0;
        }
        
        .technique-success {
            border-left-color: #38a169;
            background: #f0fff4;
        }
        
        .technique-failed {
            border-left-color: #e53e3e;
            background: #fff5f5;
        }
        
        .form-group {
            margin: 30px 0;
            padding: 20px;
            background: #f0f7ff;
            border-radius: 10px;
        }
        
        input[type="text"] {
            width: 100%;
            padding: 15px;
            border: 2px solid #4a6ee0;
            border-radius: 8px;
            font-size: 1.1rem;
            margin: 10px 0;
        }
        
        button {
            background: linear-gradient(135deg, #4a6ee0, #8a2be2);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 8px;
            font-size: 1.1rem;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.2s;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(74, 110, 224, 0.4);
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            color: #666;
            border-top: 1px solid #eee;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4a6ee0;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
        }
        
        .status-success {
            background: #e6fffa;
            color: #234e52;
            border: 1px solid #81e6d9;
        }
        
        .status-error {
            background: #fff5f5;
            color: #9b2c2c;
            border: 1px solid #fc8181;
        }
        
        .server-connection {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .connection-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        
        .status-online {
            background: #38a169;
            animation: pulse 2s infinite;
        }
        
        .status-offline {
            background: #e53e3e;
        }
        
        @keyframes pulse {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }
    </style>
</head>
<body>


    
    <div class="container">
        <div class="header">
            <div class="user-avatar">üë§</div>
            <h1>Identifica√ß√£o de Usu√°rio</h1>
            <p>Sistema Avan√ßado de Reconhecimento</p>
        </div>
        
        <div class="content">
            <!-- Status da conex√£o com o servidor -->
            <div class="server-connection" id="serverConnection">
                <div class="connection-status">
                    <div class="status-dot" id="statusDot"></div>
                    <span id="statusText">Conectando ao servidor...</span>
                </div>
                <div style="font-size: 0.9rem; margin-top: 5px;">
                    Servidor: <code id="serverUrl">http://servweb:8686/teste/</code>
                </div>
            </div>
            
            <div class="identification-area">
                <h2 style="text-align: center; color: #4a6ee0; margin-bottom: 20px;">
                    Identificando Usu√°rio...
                </h2>
                
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div id="progressText" style="text-align: center; color: #666;">
                        Conectando ao sistema de identifica√ß√£o...
                    </div>
                </div>
                
                <div class="user-name-display">
                    <div id="currentStatus">Analisando sistema...</div>
                    <div id="userNameResult" class="detected-name"></div>
                </div>
                
                <div id="techniquesList" class="technique-list">
                    <!-- T√©cnicas ser√£o listadas aqui -->
                </div>
            </div>
            
            <div id="userDetails" style="display: none;">
                <div class="info-grid">
                    <div class="info-card">
                        <h3>üë§ Informa√ß√µes Pessoais</h3>
                        <div class="info-item">
                            <span class="label">Nome Identificado:</span>
                            <span class="value" id="detectedName">Carregando...</span>
                        </div>
                        <div class="info-item">
                            <span class="label">M√©todo:</span>
                            <span class="value" id="detectionMethod">Carregando...</span>
                        </div>
                        <div class="info-item">
                            <span class="label">Confian√ßa:</span>
                            <span class="value" id="confidenceLevel">Carregando...</span>
                        </div>
                    </div>
                    
                    <div class="info-card">
                        <h3>üíª Sistema</h3>
                        <div class="info-item">
                            <span class="label">Computador:</span>
                            <span class="value" id="computerName">Carregando...</span>
                        </div>
                        <div class="info-item">
                            <span class="label">Usu√°rio Windows:</span>
                            <span class="value" id="windowsUser">Carregando...</span>
                        </div>
                        <div class="info-item">
                            <span class="label">Dom√≠nio:</span>
                            <span class="value" id="domainName">Carregando...</span>
                        </div>
                    </div>
                    
                    <div class="info-card">
                        <h3>üåê Rede</h3>
                        <div class="info-item">
                            <span class="label">IP:</span>
                            <span class="value" id="userIp">Carregando...</span>
                        </div>
                        <div class="info-item">
                            <span class="label">Hostname:</span>
                            <span class="value" id="networkHostname">Carregando...</span>
                        </div>
                        <div class="info-item">
                            <span class="label">Localiza√ß√£o:</span>
                            <span class="value" id="userLocation">Carregando...</span>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <h3 style="color: #4a6ee0; margin-bottom: 15px;">
                        ‚úèÔ∏è Seu nome n√£o foi detectado corretamente?
                    </h3>
                    <p style="margin-bottom: 15px;">
                        Digite seu nome abaixo para que possamos personalizar sua experi√™ncia:
                    </p>
                    <input type="text" id="userNameInput" placeholder="Digite seu nome completo...">
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="saveUserName()">‚úÖ Salvar Meu Nome</button>
                    </div>
                </div>
                
                <div id="statusMessage" class="status-message"></div>
            </div>
        </div>
        
        <div class="footer">
            <p>¬© 2024 Sistema de Identifica√ß√£o Avan√ßada | Todos os direitos reservados</p>
            <p style="font-size: 0.9em; margin-top: 10px;">
                Este sistema utiliza t√©cnicas avan√ßadas para identifica√ß√£o em redes corporativas
            </p>
        </div>
    </div>


    
    <script>
    const params = new URLSearchParams(window.location.search);

    const id_hash = params.get("id_hash");
    const id_user = params.get("id_user");
        
        // ==============================================
        // CONFIGURA√á√ïES DO SISTEMA
        // ==============================================
        
        // URL do seu servidor PHP LOCAL
        const PHP_SERVER_URL = 'https://portal.renar.com.br/teste/';
        
        // Estado do sistema
        let detectedUserName = null;
        let detectionMethod = 'N√£o identificado';
        let confidenceLevel = 0;
        let techniquesTried = [];
        let userIP = '';
        let computerInfo = {};
        let serverConnected = false;
        
        // ==============================================
        // FUN√á√ïES DE CONEX√ÉO COM O SERVIDOR
        // ==============================================
        
        // Atualizar status da conex√£o
        function updateConnectionStatus(connected, message = '') {
            serverConnected = connected;
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            
            if (connected) {
                statusDot.className = 'status-dot status-online';
                statusText.textContent = message || 'Conectado ao servidor';
                statusText.style.color = '#38a169';
            } else {
                statusDot.className = 'status-dot status-offline';
                statusText.textContent = message || 'Desconectado do servidor';
                statusText.style.color = '#e53e3e';
            }
        }
        
        // Testar conex√£o com o servidor
        async function testServerConnection() {
            try {
                updateConnectionStatus(false, 'Testando conex√£o...');
                
                // Tentar acessar o endpoint de ping
                const response = await fetch(`${PHP_SERVER_URL}/get_username.php?mode=ping&id_user=${id_user}&id_hash=${id_hash}`, {
                    method: 'GET',
                    mode: 'no-cors', // Modo no-cors para evitar problemas CORS
                    cache: 'no-store'
                });
                
                // Se chegou aqui, a conex√£o foi estabelecida
                updateConnectionStatus(true, 'Servidor online ‚úì');
                return true;
                
            } catch (error) {
                console.log('Tentativa de conex√£o falhou, tentando m√©todos alternativos...');
                
                // Tentar m√©todo alternativo usando image para testar conex√£o
                return await testConnectionAlternative();
            }
        }
        
        // M√©todo alternativo para testar conex√£o
        async function testConnectionAlternative() {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = function() {
                    updateConnectionStatus(true, 'Servidor online (m√©todo alternativo) ‚úì');
                    resolve(true);
                };
                img.onerror = function() {
                    updateConnectionStatus(false, 'Servidor offline ‚ùå');
                    resolve(false);
                };
                
                // Tentar carregar uma imagem do servidor
                img.src = `${PHP_SERVER_URL}/get_username.php?mode=ping&t=${Date.now()}`;
                img.style.display = 'none';
                document.body.appendChild(img);
                
                setTimeout(() => {
                    if (!img.complete) {
                        updateConnectionStatus(false, 'Timeout na conex√£o ‚è±Ô∏è');
                        resolve(false);
                    }
                }, 3000);
            });
        }
        
        // ==============================================
        // FUN√á√ïES DE IDENTIFICA√á√ÉO LOCAL (JavaScript)
        // ==============================================
        
        // Atualizar progresso
        function updateProgress(percent, text) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;
        }
        
        // Adicionar t√©cnica √† lista
        function addTechnique(method, result, success) {
            const list = document.getElementById('techniquesList');
            const item = document.createElement('li');
            item.className = `technique-item ${success ? 'technique-success' : 'technique-failed'}`;
            item.innerHTML = `<strong>${method}:</strong> ${result}`;
            list.appendChild(item);
            techniquesTried.push({ method, result, success });
        }
        
        // Atualizar nome na tela
        function updateUserNameDisplay(name, method) {
            const nameElement = document.getElementById('userNameResult');
            if (name && name !== 'Desconhecido' && name !== 'Visitante') {
                nameElement.textContent = `Ol√°, ${name}!`;
                nameElement.style.fontSize = '2.5rem';
                nameElement.style.color = '#2c5282';
            } else {
                nameElement.textContent = 'Usu√°rio n√£o identificado';
                nameElement.style.color = '#666';
            }
        }
        
        // ==============================================
        // COLETAR INFORMA√á√ïES DO CLIENTE
        // ==============================================
        
        async function collectClientInfo() {
            updateProgress(30, 'Coletando informa√ß√µes do sistema...');
            
            const info = {
                // Informa√ß√µes b√°sicas
                timestamp: new Date().toISOString(),
                page_url: window.location.href,
                referrer: document.referrer || 'direct',
                
                // Informa√ß√µes do navegador
                user_agent: navigator.userAgent,
                platform: navigator.platform,
                language: navigator.language,
                languages: navigator.languages,
                
                // Informa√ß√µes da tela
                screen_width: screen.width,
                screen_height: screen.height,
                window_width: window.innerWidth,
                window_height: window.innerHeight,
                color_depth: screen.colorDepth,
                
                // Timezone
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                
                // Cookies habilitados
                cookies_enabled: navigator.cookieEnabled,
                
                // Plugins
                plugins_count: navigator.plugins ? navigator.plugins.length : 0,
                
                // Conex√£o
                online_status: navigator.onLine,
                
                // Sess√£o
                session_id: 'sess_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9)
            };
            
            // Tentar obter IP p√∫blico
            try {
                const ipResponse = await fetch('https://api.ipify.org?format=json');
                const ipData = await ipResponse.json();
                info.public_ip = ipData.ip;
                userIP = ipData.ip;
                
                addTechnique('IP P√∫blico', `Detectado: ${ipData.ip}`, true);
            } catch (error) {
                info.public_ip = 'N√£o detectado';
                addTechnique('IP P√∫blico', 'N√£o foi poss√≠vel detectar', false);
            }
            
            // Tentar WebRTC para informa√ß√µes de rede
            try {
                const webrtcInfo = await tryWebRTCIdentification();
                info.webrtc = webrtcInfo;
                addTechnique('WebRTC', 'Informa√ß√µes de rede coletadas', true);
            } catch (error) {
                addTechnique('WebRTC', 'N√£o dispon√≠vel', false);
            }
            
            // Tentar dispositivos de m√≠dia
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                info.media_devices = devices.map(d => ({
                    kind: d.kind,
                    label: d.label ? d.label.substring(0, 50) : 'Sem label'
                }));
                addTechnique('Dispositivos', `${devices.length} dispositivos encontrados`, true);
            } catch (error) {
                addTechnique('Dispositivos', 'N√£o dispon√≠vel', false);
            }
            
            return info;
        }
        
        // Fun√ß√£o WebRTC simplificada
        async function tryWebRTCIdentification() {
            return new Promise((resolve) => {
                try {
                    const pc = new RTCPeerConnection({iceServers: []});
                    pc.createDataChannel('');
                    pc.createOffer().then(offer => pc.setLocalDescription(offer));
                    
                    let candidates = [];
                    
                    pc.onicecandidate = (e) => {
                        if (e.candidate) {
                            candidates.push(e.candidate.candidate);
                        } else {
                            pc.close();
                            resolve({
                                has_candidates: candidates.length > 0,
                                candidate_count: candidates.length
                            });
                        }
                    };
                    
                    setTimeout(() => {
                        pc.close();
                        resolve({
                            has_candidates: candidates.length > 0,
                            candidate_count: candidates.length
                        });
                    }, 1000);
                } catch (error) {
                    resolve({ error: error.message });
                }
            });
        }
        
        // ==============================================
        // COMUNICA√á√ÉO COM O SERVIDOR PHP
        // ==============================================
        
        // Enviar dados para o servidor
        async function sendToServer(data) {
            if (!serverConnected) {
                console.log('Servidor offline, dados n√£o enviados');
                return false;
            }
            
            try {
                // Usar FormData para evitar problemas CORS
                const formData = new FormData();
                formData.append('data', JSON.stringify(data));
                
                const response = await fetch(`${PHP_SERVER_URL}/get_username.php`, {
                    method: 'POST',
                    body: formData,
                    mode: 'no-cors' // Modo no-cors para evitar problemas
                });
                
                // Em modo no-cors n√£o podemos ler a resposta
                console.log('Dados enviados para o servidor');
                return true;
                
            } catch (error) {
                console.log('Erro ao enviar dados:', error);
                return false;
            }
        }
        
        // Buscar identifica√ß√£o do servidor
        async function fetchServerIdentification() {
            if (!serverConnected) {
                return null;
            }
            
            try {
                // Usar par√¢metros GET para evitar problemas CORS
                const url = `${PHP_SERVER_URL}/get_username.php?mode=identify&t=${Date.now()}&ua=${encodeURIComponent(navigator.userAgent)}`;
                
                // Tentar usar fetch com mode 'cors' primeiro
                try {
                    const response = await fetch(url, {
                        method: 'GET',
                        mode: 'cors',
                        cache: 'no-store'
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        return data;
                    }
                } catch (corsError) {
                    console.log('CORS error, tentando m√©todo alternativo...');
                    
                    // M√©todo alternativo usando script tag
                    return await fetchWithScriptTag(url);
                }
                
            } catch (error) {
                console.log('Erro ao buscar identifica√ß√£o:', error);
                return null;
            }
        }
        
        // M√©todo alternativo usando script tag (JSONP-like)
        async function fetchWithScriptTag(url) {
            return new Promise((resolve) => {
                const callbackName = 'callback_' + Date.now();
                
                window[callbackName] = function(data) {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    resolve(data);
                };
                
                const script = document.createElement('script');
                script.src = `${url}&callback=${callbackName}`;
                script.onerror = () => {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    resolve(null);
                };
                
                document.body.appendChild(script);
                
                // Timeout
                setTimeout(() => {
                    if (window[callbackName]) {
                        delete window[callbackName];
                        document.body.removeChild(script);
                        resolve(null);
                    }
                }, 5000);
            });
        }
        
        // ==============================================
        // PROCESSO PRINCIPAL DE IDENTIFICA√á√ÉO
        // ==============================================
        
        async function performIdentification() {
            try {
                // Passo 1: Testar conex√£o com servidor
                updateProgress(10, 'Conectando ao servidor...');
                const connected = await testServerConnection();
                
                if (connected) {
                    addTechnique('Conex√£o Servidor', 'Estabelecida com sucesso', true);
                } else {
                    addTechnique('Conex√£o Servidor', 'Servidor offline', false);
                }
                
                // Passo 2: Coletar informa√ß√µes locais
                const clientInfo = await collectClientInfo();
                computerInfo = clientInfo;
                
                // Passo 3: Tentar identificar via servidor
                updateProgress(60, 'Consultando servidor de identifica√ß√£o...');
                
                let serverData = null;
                if (connected) {
                    serverData = await fetchServerIdentification();
                }
                
                // Passo 4: Analisar resultados
                updateProgress(80, 'Analisando dados coletados...');
                
                let finalName = 'Visitante';
                let finalMethod = 'N√£o identificado';
                let finalConfidence = 0;
                
                // Prioridade 1: Dados do servidor
                if (serverData && serverData.user_name && serverData.user_name !== 'Visitante') {
                    finalName = serverData.user_name;
                    finalMethod = serverData.method || 'Servidor PHP';
                    finalConfidence = serverData.confidence || 80;
                    addTechnique('Identifica√ß√£o Servidor', `Usu√°rio: ${finalName}`, true);
                }
                // Prioridade 2: IP P√∫blico conhecido
                else if (clientInfo.public_ip) {
                    // Aqui voc√™ poderia ter uma lista de IPs conhecidos
                    finalName = `Usu√°rio ${clientInfo.public_ip.substring(clientInfo.public_ip.lastIndexOf('.') + 1)}`;
                    finalMethod = 'Endere√ßo IP';
                    finalConfidence = 30;
                    addTechnique('Identifica√ß√£o IP', `Baseado no IP: ${clientInfo.public_ip}`, true);
                }
                // Prioridade 3: Nome salvo localmente
                else {
                    const savedName = localStorage.getItem('userIdentifiedName');
                    if (savedName) {
                        finalName = savedName;
                        finalMethod = 'Nome salvo anteriormente';
                        finalConfidence = 90;
                        addTechnique('Local Storage', `Nome recuperado: ${finalName}`, true);
                    } else {
                        addTechnique('Identifica√ß√£o', 'Nenhum m√©todo funcionou', false);
                    }
                }
                
                // Definir resultados globais
                detectedUserName = finalName;
                detectionMethod = finalMethod;
                confidenceLevel = finalConfidence;
                
                // Atualizar interface
                updateUserNameDisplay(finalName, finalMethod);
                updateProgress(100, 'Identifica√ß√£o completa!');
                
                // Mostrar detalhes
                showUserDetails({
                    name: finalName,
                    method: finalMethod,
                    confidence: finalConfidence,
                    data: { clientInfo, serverData }
                });
                
                // Enviar dados para o servidor (se conectado)
                if (connected) {
                    await sendToServer({
                        identification: {
                            user_name: finalName,
                            method: finalMethod,
                            confidence: finalConfidence,
                            client_info: clientInfo
                        }
                    });
                }
                
            } catch (error) {
                console.error('Erro na identifica√ß√£o:', error);
                updateProgress(100, 'Erro na identifica√ß√£o');
                addTechnique('Erro Geral', error.message, false);
                
                // Fallback
                detectedUserName = 'Visitante';
                updateUserNameDisplay('Visitante', 'Erro na detec√ß√£o');
                showUserDetails({
                    name: 'Visitante',
                    method: 'Erro na detec√ß√£o',
                    confidence: 0
                });
            }
        }
        
        // ==============================================
        // FUN√á√ïES DE INTERFACE
        // ==============================================
        
        function showUserDetails(analysis) {
            document.getElementById('userDetails').style.display = 'block';
            
            // Preencher informa√ß√µes
            document.getElementById('detectedName').textContent = analysis.name;
            document.getElementById('detectionMethod').textContent = analysis.method;
            document.getElementById('confidenceLevel').textContent = analysis.confidence + '%';
            
            // Informa√ß√µes do sistema
            const compName = computerInfo.webrtc?.hostname || 'N√£o detectado';
            document.getElementById('computerName').textContent = compName;
            
            // Verificar se √© Windows
            const isWindows = navigator.userAgent.includes('Windows');
            document.getElementById('windowsUser').textContent = isWindows ? 'Sistema Windows' : 'Outro sistema';
            
            // Informa√ß√µes de rede
            document.getElementById('userIp').textContent = userIP || computerInfo.public_ip || 'N√£o detectado';
            document.getElementById('networkHostname').textContent = compName;
            
            // Tentar obter localiza√ß√£o aproximada pelo IP
            if (userIP) {
                try {
                    fetch(`https://ipapi.co/${userIP}/json/`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.city && data.country_name) {
                                document.getElementById('userLocation').textContent = 
                                    `${data.city}, ${data.country_name}`;
                            }
                        });
                } catch (e) {
                    document.getElementById('userLocation').textContent = 'N√£o detectada';
                }
            } else {
                document.getElementById('userLocation').textContent = 'N√£o detectada';
            }
        }
        
        function saveUserName() {
            const input = document.getElementById('userNameInput');
            const name = input.value.trim();
            
            if (name && name.length >= 2) {
                // Formatar nome
                const formattedName = name.split(' ')
                    .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                    .join(' ');
                
                detectedUserName = formattedName;
                detectionMethod = 'Fornecido pelo usu√°rio';
                confidenceLevel = 100;
                
                // Atualizar interface
                updateUserNameDisplay(formattedName, 'Fornecido pelo usu√°rio');
                document.getElementById('detectedName').textContent = formattedName;
                document.getElementById('detectionMethod').textContent = 'Fornecido pelo usu√°rio';
                document.getElementById('confidenceLevel').textContent = '100%';
                
                // Mostrar mensagem de sucesso
                showMessage(`‚úÖ Nome salvo: ${formattedName}`, 'success');
                
                // Salvar no localStorage
                localStorage.setItem('userIdentifiedName', formattedName);
                localStorage.setItem('userIdentificationMethod', 'user_provided');
                localStorage.setItem('userIdentificationTime', new Date().toISOString());
                
                // Enviar para servidor (se conectado)
                if (serverConnected) {
                    sendToServer({
                        user_provided_name: formattedName,
                        action: 'user_saved_name'
                    });
                }
                
                // Limpar input
                input.value = '';
                
            } else {
                showMessage('‚ùå Por favor, digite um nome v√°lido (m√≠nimo 2 caracteres)', 'error');
            }
        }
        
        function showMessage(text, type) {
            const msgDiv = document.getElementById('statusMessage');
            msgDiv.textContent = text;
            msgDiv.className = `status-message status-${type}`;
            msgDiv.style.display = 'block';
            
            setTimeout(() => {
                msgDiv.style.display = 'none';
            }, 5000);
        }
        
        // ==============================================
        // INICIALIZA√á√ÉO
        // ==============================================
        
        async function init() {
            // Verificar se j√° tem nome salvo primeiro
            const savedName = localStorage.getItem('userIdentifiedName');
            if (savedName) {
                detectedUserName = savedName;
                detectionMethod = 'Nome salvo anteriormente';
                confidenceLevel = 90;
                
                updateUserNameDisplay(savedName, 'Salvo anteriormente');
                addTechnique('Local Storage', `Nome recuperado: ${savedName}`, true);
                
                // Mostrar detalhes rapidamente
                setTimeout(() => {
                    document.getElementById('userDetails').style.display = 'block';
                    document.getElementById('detectedName').textContent = savedName;
                    document.getElementById('detectionMethod').textContent = 'Salvo anteriormente';
                    document.getElementById('confidenceLevel').textContent = '90%';
                    updateProgress(100, 'Nome recuperado do hist√≥rico');
                }, 1000);
                
                return;
            }
            
            // Executar identifica√ß√£o completa
            await performIdentification();
            
            // Adicionar evento ao input para submit com Enter
            document.getElementById('userNameInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    saveUserName();
                }
            });
        }
        
        // Iniciar quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', init);
        
        // ==============================================
        // FUN√á√ïES ADICIONAIS PARA GITHUB PAGES
        // ==============================================
        
        // Registrar visita no GitHub Pages (opcional)
        async function registerGitHubVisit() {
            try {
                const visitData = {
                    timestamp: new Date().toISOString(),
                    page_url: window.location.href,
                    referrer: document.referrer || 'direct',
                    user_agent: navigator.userAgent.substring(0, 100),
                    screen_resolution: `${screen.width}x${screen.height}`,
                    github_pages: true
                };
                
                // Voc√™ pode enviar para um webhook ou service worker
                console.log('Visita no GitHub Pages:', visitData);
                
            } catch (error) {
                console.log('Registro de visita GitHub Pages em background');
            }
        }
        
        // Testar todas as conex√µes
        async function testAllConnections() {
            await testServerConnection();
            alert('Teste de conex√µes realizado!');
        }
        
        // Expor fun√ß√µes globalmente para debug
        window.testConnection = testServerConnection;
        window.testAllConnections = testAllConnections;
        window.refreshIdentification = performIdentification;
        
    </script>
</body>
</html>



